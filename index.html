<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kierowca - Linia O1</title>
<style>
  body {
    font-family: sans-serif;
    padding: 20px;
    max-width: 600px;
    margin: auto;
    background: #f0f2f5;
  }
  h1, h2 {
    text-align: center;
  }
  button {
    width: 100%;
    padding: 15px;
    font-size: 18px;
    margin: 10px 0;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:disabled {
    background-color: #999;
    cursor: not-allowed;
  }
  .event-log {
    margin-top: 20px;
    background: white;
    padding: 10px;
    border-radius: 8px;
    height: 250px;
    overflow-y: auto;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
    font-size: 15px;
  }
  #countdown {
    font-size: 22px;
    margin-bottom: 10px;
    text-align: center;
    color: #333;
  }
</style>
</head>
<body>
  <h1>Linia O1 ‚Äì Sterowanie trasƒÖ</h1>
  <h2 id="countdown">≈Åadowanie...</h2>
  <button id="manualStartBtn">‚ñ∂Ô∏è Uruchom trasƒô rƒôcznie</button>
  <div class="event-log" id="log"></div>

<script>
  const SCHEDULE = [
    { time: 0,  audio: "https://sparklyfrog2060.github.io/Autobus/1.mp3", label: "Start: Ocytko Taras" },
    { time: 17, audio: "https://sparklyfrog2060.github.io/Autobus/2.mp3", label: "Przystanek: Ocytko Wyjazd" },
    { time: 24, audio: "https://sparklyfrog2060.github.io/Autobus/1.mp3", label: "Zapowied≈∫: Ocytko Szopa" },
    { time: 28, audio: "https://sparklyfrog2060.github.io/Autobus/3.mp3", label: "Przystanek: Ocytko Szopa" },
    { time: 36, audio: "https://sparklyfrog2060.github.io/Autobus/1.mp3", label: "Zapowied≈∫: Ocytko Gara≈º" },
    { time: 40, audio: "https://sparklyfrog2060.github.io/Autobus/4.mp3", label: "Przystanek: Ocytko Gara≈º" },
    { time: 47, audio: "https://sparklyfrog2060.github.io/Autobus/1.mp3", label: "Zapowied≈∫: Ocytko Taras (powr√≥t)" }
  ];

  const logBox = document.getElementById("log");
  const manualStartBtn = document.getElementById("manualStartBtn");
  const countdownEl = document.getElementById("countdown");
  let started = false;
  let intervalId = null;
  let startTimeoutId = null;

  function log(msg) {
    const time = new Date().toLocaleTimeString();
    logBox.innerHTML += `[${time}] ${msg}<br>`;
    logBox.scrollTop = logBox.scrollHeight;
  }

  function playSound(src) {
    const audio = new Audio(src);
    // Dodaj event, ≈ºeby odtworzyƒá i wy≈Çapaƒá b≈Çƒôdy
    audio.play().catch(e => {
      console.warn("B≈ÇƒÖd odtwarzania audio:", e);
      log("‚ö†Ô∏è Nie uda≈Ço siƒô odtworzyƒá d≈∫wiƒôku");
    });
  }

  function playSchedule() {
    if (started) {
      log("‚è∞ Trasa ju≈º trwa, nie mo≈ºna uruchomiƒá ponownie");
      return;
    }
    started = true;
    manualStartBtn.disabled = true;
    log("üîÅ Trasa rozpoczƒôta");

    SCHEDULE.forEach(event => {
      setTimeout(() => {
        playSound(event.audio);
        log("‚ñ∂Ô∏è " + event.label);
      }, event.time * 1000);
    });

    const maxTime = Math.max(...SCHEDULE.map(e => e.time));
    setTimeout(() => {
      started = false;
      manualStartBtn.disabled = false;
      log("‚úÖ Trasa zako≈Ñczona, czekamy na nastƒôpny start");
      scheduleAutoStart();
    }, (maxTime + 1) * 1000);
  }

  function getNextStartDelay() {
    const now = new Date();
    const minutes = now.getMinutes();
    const seconds = now.getSeconds();
    const remainder = minutes % 2;
    const nextMinute = minutes + (2 - remainder);
    const nextStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), nextMinute, 0, 0);

    let delay = nextStart - now;
    if (delay < 0) delay += 2 * 60 * 1000;

    return delay;
  }

  function updateCountdown() {
    const delay = getNextStartDelay();
    const secondsLeft = Math.floor(delay / 1000);
    countdownEl.textContent = `‚è≥ Start trasy za: ${secondsLeft} s`;
  }

  function scheduleAutoStart() {
    updateCountdown();
    let delay = getNextStartDelay();

    if (startTimeoutId) clearTimeout(startTimeoutId);
    if (intervalId) clearInterval(intervalId);

    startTimeoutId = setTimeout(() => {
      playSchedule();
      intervalId = setInterval(updateCountdown, 1000);
    }, delay);

    if (!intervalId) intervalId = setInterval(updateCountdown, 1000);
  }

  manualStartBtn.onclick = () => {
    playSchedule();
  };

  window.onload = () => {
    scheduleAutoStart();
  };
</script>
</body>
</html>
